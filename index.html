<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Reordering Game</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #666;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .sentence-list {
            list-style-type: none;
            margin-bottom: 20px;
        }
        
        .sentence-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 2px solid #eee;
            cursor: move;
            transition: all 0.2s;
        }
        
        .sentence-item:hover {
            background-color: #e9ecef;
            border-color: var(--primary-color);
        }
        
        .sentence-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color);
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        
        .instructions h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .progress-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: bold;
        }
        
        .step.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step.completed {
            background-color: var(--success-color);
            color: white;
        }
        
        .feedback {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        .success {
            color: var(--success-color);
        }
        
        .warning {
            color: var(--warning-color);
        }
        
        .error {
            color: var(--error-color);
        }
        
        .results {
            text-align: center;
        }
        
        .results-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--secondary-color);
        }
        
        .score {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .score-value {
            font-weight: bold;
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        .feedback-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Email Reordering Game</h1>
            <p>Arrange sentences in logical order to improve your comprehension skills</p>
        </div>
        
        <div id="registration-section" class="card">
            <h2 class="section-title">Student Registration</h2>
            <form id="registration-form">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="roll">Roll Number</label>
                    <input type="text" id="roll" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="department">Department</label>
                    <input type="text" id="department" class="form-control" required>
                </div>
                
                <button type="submit" class="btn btn-block">Start Game</button>
            </form>
        </div>
        
        <div id="game-section" class="hidden">
            <div class="progress-indicator">
                <div class="step active" id="situation-1-step">Situation 1</div>
                <div class="step" id="situation-2-step">Situation 2</div>
                <div class="step" id="results-step">Results</div>
            </div>
            
            <div class="card">
                <div class="timer" id="timer">Time Remaining: 01:30</div>
                
                <div class="instructions">
                    <h3>Instructions:</h3>
                    <p>Drag and drop the sentences to arrange them in a logical order. You have 1:30 minutes to complete each situation.</p>
                </div>
                
                <h2 class="section-title" id="situation-title">Situation 1: The Scientific Method</h2>
                
                <ul class="sentence-list" id="sentence-list"></ul>
                
                <button id="submit-btn" class="btn btn-block">Submit Answers</button>
            </div>
        </div>
        
        <div id="results-section" class="hidden">
            <div class="card results">
                <h2 class="results-title">Assessment Results</h2>
                
                <div class="score">
                    Your Score: <span class="score-value" id="final-score"></span>
                </div>
                
                <div class="feedback-message" id="feedback-message"></div>
                
                <div>
                    <p>Time Taken: <span id="total-time"></span></p>
                    <p>Completed on: <span id="completion-date"></span></p>
                </div>
                
                <div style="margin-top: 30px;">
                    <p>Your assessment has been saved. You cannot retake this assessment.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
    apiKey: "AIzaSyDXf5DooFzNB24KzvupGiL2iL8WvhcWE8Y",
    authDomain: "mail-reordering-game.firebaseapp.com",
    projectId: "mail-reordering-game",
    storageBucket: "mail-reordering-game.firebasestorage.app",
    messagingSenderId: "509000994429",
    appId: "1:509000994429:web:6159aed7e6b67fd2feab14",
    measurementId: "G-H2NTTPRWR6"
  };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Game Variables
        const allSituations = [
    {
        "id": 1,
        "title": "Situation 1: Requesting Information for a Report",
        "sentences": [
            "I'm currently working on the quarterly report that's due next week.",
            "I need some specific data regarding the recent marketing campaign results.",
            "Could you please share the conversion rates and customer engagement metrics?",
            "This information will help me complete the analysis section of the report.",
            "I would appreciate receiving this by Wednesday to meet our deadline."
        ],
        "correctOrder": [0, 1, 2, 4, 3],
        "salutation": {
            "position": " Manager",
            "options": ["Dear", "Respected", "Hello"]
        }
    },
    {
        "id": 2,
        "title": "Situation 2: Proposing a New Project Idea",
        "sentences": [
            "I've been thinking about ways to improve our customer satisfaction scores.",
            "My proposal involves implementing a new feedback system across all departments.",
            "This system would collect real-time data and provide actionable insights.",
            "The initial investment would be offset by improved retention rates.",
            "Would you be interested in discussing this further at the next team meeting?"
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Project Director",
            "options": ["Dear", "Respected", "Hello"]
        }
    },
    {
        "id": 3,
        "title": "Situation 3: Rescheduling a Client Meeting",
        "sentences": [
            "I'm writing regarding our scheduled meeting tomorrow at 2 PM.",
            "Unfortunately, I need to request a postponement due to an unexpected conflict.",
            "I sincerely apologize for any inconvenience this may cause.",
            "Would either Thursday at 11 AM or Friday at 3 PM work for you instead?",
            "I look forward to your response and appreciate your understanding."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Client Representative",
            "options": ["Dear", "Hi", "Greetings"]
        }
    },
    {
        "id": 4,
        "title": "Situation 4: Addressing a Customer Complaint",
        "sentences": [
            "Thank you for bringing this issue to our attention.",
            "We sincerely apologize for the inconvenience you've experienced with our product.",
            "Our team has investigated the matter and identified the root cause.",
            "As compensation, we'd like to offer you a full refund and a discount on your next purchase.",
            "Please let us know if this resolution is satisfactory or if you have any questions."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Customer Service Representative",
            "options": ["Dear", "Hello", "Valued Customer"]
        }
    },
    {
        "id": 5,
        "title": "Situation 5: Following Up After a Job Interview",
        "sentences": [
            "I wanted to thank you for the opportunity to interview for the Marketing Manager position.",
            "I enjoyed our conversation about the company's growth strategy and vision.",
            "After our discussion, I'm even more enthusiastic about potentially joining your team.",
            "I'd be happy to provide any additional information that might help with your decision.",
            "I look forward to hearing from you regarding the next steps in the process."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Hiring Manager",
            "options": ["Dear", "Hello"]
        }
    },
    {
        "id": 6,
        "title": "Situation 6: Submitting a Budget Request",
        "sentences": [
            "I've attached the proposed budget for the upcoming quarter for your review.",
            "The budget includes a 15% increase in our marketing allocation based on projected growth.",
            "We've also reduced operational expenses by implementing new automation tools.",
            "These changes should allow us to meet our revenue targets while controlling costs.",
            "Please let me know if you have any questions or require further justification."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Finance Director",
            "options": ["Dear", "Respected"]
        }
    },
    {
        "id": 7,
        "title": "Situation 7: Requesting Feedback on a Proposal",
        "sentences": [
            "I've prepared a proposal for the new client onboarding process as discussed.",
            "The document outlines key improvements to streamline the experience for new customers.",
            "I'd appreciate your thoughts on the suggested timeline and resource allocation.",
            "Your perspective would be valuable before I present this to the management team.",
            "Would you have time to review it before Friday's meeting?"
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Team Leader",
            "options": ["Dear", "Hello"]
        }
    },
    {
        "id": 8,
        "title": "Situation 8: Announcing a Policy Change",
        "sentences": [
            "After careful consideration, we're implementing changes to our remote work policy.",
            "Starting next month, employees will be required to work from the office three days per week.",
            "This decision aims to balance flexibility with the benefits of in-person collaboration.",
            "We understand this represents a significant change from our current arrangements.",
            "Department heads will schedule team meetings to address any questions or concerns."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "HR Director",
            "options": ["Dear", "Hello", "Attention"]
        }
    },
    {
        "id": 9,
        "title": "Situation 9: Resolving a Misunderstanding",
        "sentences": [
            "I believe there's been a misunderstanding regarding yesterday's presentation.",
            "My comments were intended as constructive feedback rather than criticism.",
            "I've always valued your contributions and innovative approach to projects.",
            "Perhaps we could discuss this in person to clear up any confusion.",
            "Maintaining open communication is important for our continued collaboration."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Team Member",
            "options": ["Dear", "Hi", "Hello"]
        }
    },
    {
        "id": 10,
        "title": "Situation 10: Requesting Time Off",
        "sentences": [
            "I'd like to request vacation time from July 10th through July 21st.",
            "I've already completed the necessary paperwork and updated our shared calendar.",
            "All my current projects will be completed before my departure.",
            "I've also arranged for Sarah to handle any urgent matters during my absence.",
            "Please let me know if you need any additional information or arrangements."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Supervisor",
            "options": ["Dear", "Hello", "Good morning"]
        }
    },
    {
        "id": 11,
        "title": "Situation 11: Responding to a Project Delay",
        "sentences": [
            "I've received your update about the project delay due to supplier issues.",
            "While this is concerning, I understand these factors were beyond our control.",
            "Let's schedule a call to discuss mitigation strategies and revised timelines.",
            "In the meantime, please prepare an updated risk assessment for stakeholders.",
            "I'm confident we can work together to minimize the impact on our deliverables."
        ],
        "correctOrder": [0, 1, 2, 4, 3],
        "salutation": {
            "position": "Project Manager",
            "options": ["Dear", "Hello", "Hi"]
        }
    },
    {
        "id": 12,
        "title": "Situation 12: Providing Technical Support",
        "sentences": [
            "I received your request about the issues with the database connection.",
            "The problem appears to be related to recent server maintenance.",
            "I've implemented a temporary fix that should restore functionality immediately.",
            "Our team is working on a permanent solution to prevent future occurrences.",
            "Please let me know if you encounter any further difficulties with the system."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "IT Support Specialist",
            "options": ["Dear", "Hello", "Hi"]
        }
    },
    {
        "id": 13,
        "title": "Situation 13: Sharing Meeting Notes",
        "sentences": [
            "I'm attaching the notes from yesterday's strategic planning meeting.",
            "We identified three key initiatives to focus on during the next quarter.",
            "The document also includes assigned responsibilities and deadlines.",
            "Please review the action items designated to your department by Monday.",
            "Let me know if you have any questions or need clarification on any points."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Department Head",
            "options": ["Dear", "Hello", "Greetings"]
        }
    },
    {
        "id": 14,
        "title": "Situation 14: Discussing a Performance Issue",
        "sentences": [
            "I'd like to discuss some concerns regarding recent project deliverables.",
            "I've noticed several deadlines have been missed over the past month.",
            "I understand there might be challenges or obstacles I'm not aware of.",
            "Could we schedule a one-on-one meeting to discuss this further?",
            "My goal is to understand the situation and provide any support needed."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Team Lead",
            "options": ["Dear", "Hello", "Hi"]
        }
    },
    {
        "id": 15,
        "title": "Situation 15: Requesting a Recommendation Letter",
        "sentences": [
            "I hope this email finds you well.",
            "I'm applying for a graduate program at University College London.",
            "Given our professional relationship over the past three years, I wanted to ask if you would consider writing a recommendation letter for me.",
            "The application deadline is March 15th, so I would need it by early March.",
            "I understand if you're too busy, and appreciate your consideration either way."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Former Supervisor",
            "options": ["Dear", "Respected", "Hello"]
        }
    },
    {
        "id": 16,
        "title": "Situation 16: Coordinating a Team Event",
        "sentences": [
            "I'm planning a team-building event for next month and would like your input.",
            "The current options are a cooking class, escape room, or outdoor adventure day.",
            "Please indicate your preference by responding to the attached survey.",
            "We'll select the option with the most votes by the end of this week.",
            "The event will take place on Friday, May 12th, from 1 PM onwards."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Team Coordinator",
            "options": ["Dear", "Hello", "Hi everyone"]
        }
    },
    {
        "id": 17,
        "title": "Situation 17: Explaining a Technical Concept",
        "sentences": [
            "I wanted to follow up on your question about the new authentication system.",
            "The system uses multi-factor authentication to enhance security protocols.",
            "This means users will need to provide multiple forms of verification.",
            "The implementation will be gradual, starting with the IT department next week.",
            "We've prepared a brief tutorial that will be sent to all users before the change."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Systems Administrator",
            "options": ["Dear", "Hello", "Hi"]
        }
    },
    {
        "id": 18,
        "title": "Situation 18: Requesting Equipment Repair",
        "sentences": [
            "I'm experiencing issues with my company laptop that's affecting my productivity.",
            "The system frequently freezes and sometimes shuts down unexpectedly.",
            "I've already tried restarting and updating all software as suggested.",
            "Would it be possible to have someone from IT examine it this week?",
            "I'm available any afternoon except Wednesday for troubleshooting."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "IT Help Desk",
            "options": ["Dear", "Hello", "Hi"]
        }
    },
    {
        "id": 19,
        "title": "Situation 19: Responding to a Project Proposal",
        "sentences": [
            "Thank you for submitting your detailed proposal for the client website redesign.",
            "Your creativity and attention to user experience principles were particularly impressive.",
            "I do have some questions regarding the timeline and resource allocation.",
            "The projected completion date seems ambitious given our other commitments.",
            "Can we schedule a call tomorrow to discuss potential adjustments?"
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Creative Director",
            "options": ["Dear", "Hello", "Hi"]
        }
    },
    {
        "id": 20,
        "title": "Situation 20: Handling a Missed Deadline",
        "sentences": [
            "I want to address the fact that we missed yesterday's deadline for the quarterly report.",
            "I take full responsibility for not managing our time and resources effectively.",
            "Several unexpected technical issues arose that significantly impacted our progress.",
            "I've already spoken with the stakeholders to explain the situation and set new expectations.",
            "We now have a revised plan to deliver the complete report by the end of this week."
        ],
        "correctOrder": [0, 1, 2, 3, 4],
        "salutation": {
            "position": "Senior Manager",
            "options": ["Dear", "Hello", "Respected"]
        }
    }
];
        
        let currentStudent = {
            name: "",
            roll: "",
            department: "",
            startTime: null,
            totalTimeTaken: 0,
            situationResults: [],
            overallScore: 0
        };
        
        let currentSituation = 0;
        let timerInterval;
        let timeRemaining = 90; // 1:30 minutes in seconds
        let draggedItem = null;
        
        // Elements
        const registrationSection = document.getElementById("registration-section");
        const gameSection = document.getElementById("game-section");
        const resultsSection = document.getElementById("results-section");
        const registrationForm = document.getElementById("registration-form");
        const sentenceList = document.getElementById("sentence-list");
        const situationTitle = document.getElementById("situation-title");
        const timerElement = document.getElementById("timer");
        const submitBtn = document.getElementById("submit-btn");
        
        // Event Listeners
        registrationForm.addEventListener("submit", handleRegistration);
        submitBtn.addEventListener("submit", checkAndContinue);
        submitBtn.addEventListener("click", checkAndContinue);
        
        // Check if student has already completed the game
        async function checkStudentExists(roll) {
            try {
                const studentRef = db.collection("students").doc(roll);
                const doc = await studentRef.get();
                return doc.exists;
            } catch (error) {
                console.error("Error checking student:", error);
                return false;
            }
        }
        
        // Handle Registration
        // Handle Registration
// This is the fix for the handleRegistration function
function showResults() {
    // Calculate overall score
    let totalScore = 0;
    currentStudent.situationResults.forEach(result => {
        totalScore += result.score;
    });
    
    currentStudent.overallScore = Math.floor(totalScore / situations.length);
    
    // Update UI
    gameSection.classList.add("hidden");
    resultsSection.classList.remove("hidden");
    
    // Update progress indicator - mark all situation steps as completed
    document.querySelectorAll(".step").forEach((step, index) => {
        if (index < situations.length) {
            step.classList.add("completed");
            step.classList.remove("active");
        } else if (index === situations.length) {
            step.classList.add("active"); // Results step
        }
    });
    
    document.getElementById("final-score").textContent = `${currentStudent.overallScore}%`;
    
    // Add detailed results including salutation
    const resultsCard = document.querySelector("#results-section .card");
    const detailedResults = document.createElement("div");
    detailedResults.className = "detailed-results";
    detailedResults.style.marginTop = "30px";
    detailedResults.style.textAlign = "left";
    
    let resultsHTML = '<h3 style="margin-bottom: 15px;">Detailed Results:</h3>';
    
    currentStudent.situationResults.forEach((result, index) => {
        const sentenceScore = Math.floor((result.userOrder.filter((val, idx) => 
            val === result.correctOrder[idx]).length / result.userOrder.length) * 80);
        
        resultsHTML += `
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <h4>${result.situationTitle}</h4>
                <p>Sentence Order: ${sentenceScore}/80 points</p>
                <p>Salutation: ${result.salutation.isCorrect ? '20/20' : '0/20'} points</p>
                <p>Your answer: ${result.salutation.userPrefix} ${result.salutation.userPosition}</p>
                <p>Correct position: ${result.salutation.correctPosition}</p>
                <p><strong>Total: ${result.score}/100 points</strong></p>
            </div>
        `;
    });
    
    detailedResults.innerHTML = resultsHTML;
    
    // Add the detailed results before the feedback message
    const feedbackMessage = document.getElementById("feedback-message");
    resultsCard.insertBefore(detailedResults, feedbackMessage);
    
    // Set feedback message
    if (currentStudent.overallScore >= 90) {
        feedbackMessage.textContent = "Excellent! You have a strong understanding of logical sentence ordering and professional salutations.";
        feedbackMessage.classList.add("success");
    } else if (currentStudent.overallScore >= 70) {
        feedbackMessage.textContent = "Good job! You have a solid grasp of sentence ordering and salutations with some room for improvement.";
        feedbackMessage.classList.add("success");
    } else if (currentStudent.overallScore >= 50) {
        feedbackMessage.textContent = "Fair effort. You understand the basics but should practice more to improve your email writing skills.";
        feedbackMessage.classList.add("warning");
    } else {
        feedbackMessage.textContent = "You need more practice with logical sentence ordering and professional salutations. Focus on identifying context and appropriate forms of address.";
        feedbackMessage.classList.add("error");
    }
    
    // Set time and date
    const minutes = Math.floor(currentStudent.totalTimeTaken / 60);
    const seconds = currentStudent.totalTimeTaken % 60;
    document.getElementById("total-time").textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById("completion-date").textContent = new Date().toLocaleString();
    
    // Save to Firebase
    try {
        saveResults();
    } catch (error) {
        console.error("Error saving results:", error);
    }
}


async function handleRegistration(e) {
    e.preventDefault();
    
    const name = document.getElementById("name").value.trim();
    const roll = document.getElementById("roll").value.trim();
    const department = document.getElementById("department").value;
    
    if (!name || !roll || !department) {
        alert("Please fill in all fields");
        return;
    }
    
    // Check if student has already taken the assessment
    const exists = await checkStudentExists(roll);
    if (exists) {
        alert("You have already completed this assessment and cannot retake it.");
        return;
    }
    
    // Save student information
    currentStudent.name = name;
    currentStudent.roll = roll;
    currentStudent.department = department;
    currentStudent.startTime = new Date();
    
    // Here's the fix: We're selecting random situations from the allSituations array
    // The original code was trying to rename situations to allSituations and then 
    // reassign situations, which causes a reference error
    const selectedSituations = getRandomSituations(allSituations, 2);
    situations = selectedSituations; // Now set the global situations variable
    
    // Start game
    registrationSection.classList.add("hidden");
    gameSection.classList.remove("hidden");
    
    // Update progress indicator for dynamic number of situations
    updateProgressIndicator();
    
    // Load first situation
    loadSituation(0);
    startTimer();
}
        
        // Load Situation
        function loadSituation(index) {
    currentSituation = index;
    
    // Update progress indicator
    document.querySelectorAll(".step").forEach(step => step.classList.remove("active"));
    if (index === 0) {
        document.getElementById("situation-1-step").classList.add("active");
    } else if (index === 1) {
        document.getElementById("situation-1-step").classList.add("completed");
        document.getElementById("situation-2-step").classList.add("active");
    }
    
    // Reset timer
    timeRemaining = 90;
    updateTimerDisplay();
    
    // Set situation title
    situationTitle.textContent = situations[index].title;
    
    // Add salutation form
    const salutationForm = document.createElement("div");
salutationForm.className = "salutation-form form-group";
salutationForm.innerHTML = `
    <label for="salutation-input">Enter the appropriate salutation position:</label>
    <div class="salutation-container">
        <input type="hidden" id="salutation-prefix" value="Dear">
        <span style="margin-right: 10px; font-weight: 500;">Dear</span>
        <input type="text" id="salutation-position" class="form-control" style="width: 85%; display: inline-block;" placeholder="Enter the position (e.g., Manager, Director)" required>
    </div>
    <p class="hint" style="font-size: 0.85rem; margin-top: 5px; color: #666;">Hint: Enter the appropriate position for this email situation.</p>
`;
    
    // Clear sentence list and add salutation form
    sentenceList.innerHTML = "";
    sentenceList.appendChild(salutationForm);
    
    // Shuffle sentences
    const shuffledSentences = [...situations[index].sentences];
    shuffleArray(shuffledSentences);
    
    // Add sentences to list
    shuffledSentences.forEach((sentence, i) => {
        const li = document.createElement("li");
        li.className = "sentence-item";
        li.textContent = sentence;
        li.draggable = true;
        li.dataset.index = situations[index].sentences.indexOf(sentence);
        
        // Add drag event listeners
        li.addEventListener("dragstart", dragStart);
        li.addEventListener("dragover", dragOver);
        li.addEventListener("drop", drop);
        li.addEventListener("dragenter", dragEnter);
        li.addEventListener("dragleave", dragLeave);
        li.addEventListener("dragend", dragEnd);
        
        sentenceList.appendChild(li);
    });
}
        
        // Timer Functions
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    checkAndContinue();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerElement.textContent = `Time Remaining: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 15) {
                timerElement.classList.add("error");
            } else {
                timerElement.classList.remove("error");
            }
        }
        
        // Drag and Drop Functions
        function dragStart() {
            draggedItem = this;
            setTimeout(() => this.classList.add("dragging"), 0);
        }
        
        function dragEnd() {
            this.classList.remove("dragging");
            draggedItem = null;
        }
        
        function dragOver(e) {
            e.preventDefault();
        }
        
        function dragEnter(e) {
            e.preventDefault();
            this.classList.add("hovered");
        }
        
        function dragLeave() {
            this.classList.remove("hovered");
        }
        
        function drop() {
            this.classList.remove("hovered");
            if (draggedItem !== this) {
                const allItems = Array.from(sentenceList.querySelectorAll(".sentence-item"));
                const draggedIndex = allItems.indexOf(draggedItem);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }
            }
        }
        
        // Check Answers and Continue
       // Check Answers and Continue
       function checkAndContinue() {
    clearInterval(timerInterval);
    
    // Calculate score for current situation
    const userOrder = Array.from(sentenceList.querySelectorAll(".sentence-item"))
        .map(item => parseInt(item.dataset.index));
    
    const correctOrder = situations[currentSituation].correctOrder;
    let score = 0;
    let correctCount = 0;
    
    // Check sentence order
    for (let i = 0; i < userOrder.length; i++) {
        if (userOrder[i] === correctOrder[i]) {
            correctCount++;
        }
    }
    
    // Check salutation
    let salutationScore = 0;
    const salutationPrefix = "Dear";
    const userPosition = document.getElementById("salutation-position").value.trim().toLowerCase();
    const correctPosition = situations[currentSituation].salutation.position.toLowerCase();
    
    // Check if the user's position matches or contains the correct position keywords
    if (userPosition === correctPosition || 
        userPosition.includes(correctPosition) || 
        correctPosition.includes(userPosition)) {
        salutationScore = 1;
    }
    
    // Calculate total score - sentence order (80%) + salutation (20%)
    score = Math.floor((correctCount / userOrder.length) * 80) + (salutationScore * 20);
    
    // Save result for current situation
    currentStudent.situationResults.push({
        situation: situations[currentSituation].id,
        situationTitle: situations[currentSituation].title,
        score: score,
        timeTaken: 90 - timeRemaining,
        userOrder: userOrder,
        correctOrder: correctOrder,
        salutation: {
            userPrefix: salutationPrefix,
            userPosition: userPosition,
            correctPosition: situations[currentSituation].salutation.position,
            isCorrect: salutationScore === 1
        }
    });
    
    // Update total time taken
    currentStudent.totalTimeTaken += (90 - timeRemaining);
    
    // Move to next situation or results
    if (currentSituation < situations.length - 1) {
        currentSituation++;
        loadSituation(currentSituation);
        startTimer();
        
        // Update progress indicator
        document.querySelectorAll(".step").forEach((step, index) => {
            if (index === currentSituation) {
                step.classList.add("active");
            } else if (index < currentSituation) {
                step.classList.add("completed");
                step.classList.remove("active");
            }
        });
    } else {
        showResults();
    }
}

        
        // Show Results
        async function showResults() {
    // Calculate overall score
    let totalScore = 0;
    currentStudent.situationResults.forEach(result => {
        totalScore += result.score;
    });
    
    currentStudent.overallScore = Math.floor(totalScore / situations.length);
    
    // Update UI
    gameSection.classList.add("hidden");
    resultsSection.classList.remove("hidden");
    
    // Update progress indicator - mark all situation steps as completed
    document.querySelectorAll(".step").forEach((step, index) => {
        if (index < situations.length) {
            step.classList.add("completed");
            step.classList.remove("active");
        } else if (index === situations.length) {
            step.classList.add("active"); // Results step
        }
    });
    
    document.getElementById("final-score").textContent = `${currentStudent.overallScore}%`;
            
            // Set feedback message
            const feedbackMessage = document.getElementById("feedback-message");
            if (currentStudent.overallScore >= 90) {
                feedbackMessage.textContent = "Excellent! You have a strong understanding of logical sentence ordering.";
                feedbackMessage.classList.add("success");
            } else if (currentStudent.overallScore >= 70) {
                feedbackMessage.textContent = "Good job! You have a solid grasp of sentence ordering with some room for improvement.";
                feedbackMessage.classList.add("success");
            } else if (currentStudent.overallScore >= 50) {
                feedbackMessage.textContent = "Fair effort. You understand the basics but should practice more to improve your skills.";
                feedbackMessage.classList.add("warning");
            } else {
                feedbackMessage.textContent = "You need more practice with logical sentence ordering. Focus on identifying sequence markers and context clues.";
                feedbackMessage.classList.add("error");
            }
            
            // Set time and date
            const minutes = Math.floor(currentStudent.totalTimeTaken / 60);
            const seconds = currentStudent.totalTimeTaken % 60;
            document.getElementById("total-time").textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById("completion-date").textContent = new Date().toLocaleString();
            
            // Save to Firebase
            try {
                await saveResults();
            } catch (error) {
                console.error("Error saving results:", error);
            }
        }
        
        // Save Results to Firebase
        async function saveResults() {
            try {
                const studentData = {
                    name: currentStudent.name,
                    roll: currentStudent.roll,
                    department: currentStudent.department,
                    startTime: firebase.firestore.Timestamp.fromDate(currentStudent.startTime),
                    completionTime: firebase.firestore.Timestamp.fromDate(new Date()),
                    totalTimeTaken: currentStudent.totalTimeTaken,
                    overallScore: currentStudent.overallScore,
                    situationResults: currentStudent.situationResults,
                    completedAt: new Date().toISOString()
                };
                
                // Use roll number as document ID to prevent duplicates
                await db.collection("students").doc(currentStudent.roll).set(studentData);
                console.log("Results saved successfully");
            } catch (error) {
                console.error("Error saving results:", error);
                throw error;
            }
        }
        
        // Utility Functions
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Utility function to get random situations
function getRandomSituations(allSituations, count) {
    // Make a copy of the array to avoid modifying the original
    const situationsCopy = [...allSituations];
    // Shuffle the situations
    shuffleArray(situationsCopy);
    // Return the first 'count' situations
    return situationsCopy.slice(0, count);
} 

// Function to update the progress indicator
function updateProgressIndicator() {
    const progressIndicator = document.querySelector('.progress-indicator');
    progressIndicator.innerHTML = '';
    
    // Create step elements for each situation plus results
    for (let i = 0; i < situations.length; i++) {
        const step = document.createElement('div');
        step.className = i === 0 ? 'step active' : 'step';
        step.id = `situation-${i+1}-step`;
        step.textContent = `Situation ${i+1}`;
        progressIndicator.appendChild(step);
    }
    
    // Add results step
    const resultsStep = document.createElement('div');
    resultsStep.className = 'step';
    resultsStep.id = 'results-step';
    resultsStep.textContent = 'Results';
    progressIndicator.appendChild(resultsStep);
}

// Leaderboard functionality
function createLeaderboard() {
    // Create leaderboard container if it doesn't exist
    if (!document.getElementById('leaderboard-container')) {
        const leaderboardContainer = document.createElement('div');
        leaderboardContainer.id = 'leaderboard-container';
        leaderboardContainer.className = 'hidden';
        leaderboardContainer.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            background-color: #fff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
        `;
        
        // Create leaderboard header
        const leaderboardHeader = document.createElement('div');
        leaderboardHeader.innerHTML = `
            <h2 style="color: #333; margin-bottom: 20px; text-align: center;">Leaderboard</h2>
            <button id="close-leaderboard" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #333;">Ã—</button>
        `;
        leaderboardContainer.appendChild(leaderboardHeader);
        
        // Create leaderboard content
        const leaderboardContent = document.createElement('div');
        leaderboardContent.id = 'leaderboard-content';
        leaderboardContainer.appendChild(leaderboardContent);
        
        // Add overlay
        const overlay = document.createElement('div');
        overlay.id = 'leaderboard-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        `;
        
        // Add to document
        document.body.appendChild(overlay);
        document.body.appendChild(leaderboardContainer);
        
        // Event listener for close button
        document.getElementById('close-leaderboard').addEventListener('click', () => {
            hideLeaderboard();
        });
        
        // Event listener for overlay
        overlay.addEventListener('click', () => {
            hideLeaderboard();
        });
    }
}

// Add leaderboard button to the results section
function addLeaderboardButton() {
    // First check if button already exists
    if (!document.getElementById('view-leaderboard-btn')) {
        const resultsSection = document.getElementById('results-section');
        
        // If results section exists, add button there
        if (resultsSection) {
            const leaderboardBtn = document.createElement('button');
            leaderboardBtn.id = 'view-leaderboard-btn';
            leaderboardBtn.textContent = 'View Leaderboard';
            leaderboardBtn.className = 'btn';
            leaderboardBtn.style.cssText = `
                background-color: #4CAF50;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 20px;
                float: right;
            `;
            
            leaderboardBtn.addEventListener('click', () => {
                promptPassword();
            });
            
            // Add button to results section
            resultsSection.appendChild(leaderboardBtn);
        } else {
            // As a fallback, add fixed button
            const leaderboardBtn = document.createElement('button');
            leaderboardBtn.id = 'view-leaderboard-btn';
            leaderboardBtn.textContent = 'View Leaderboard';
            leaderboardBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 10px 20px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                z-index: 900;
            `;
            
            leaderboardBtn.addEventListener('click', () => {
                promptPassword();
            });
            
            document.body.appendChild(leaderboardBtn);
        }
    }
}

// Password prompt
function promptPassword() {
    const password = prompt('Enter password to view leaderboard:');
    if (password === 'grammargenius') {
        loadLeaderboard();
    } else if (password !== null) {
        alert('Incorrect password');
    }
}

// Create and populate leaderboard table
function createLeaderboardTable(studentsData) {
    const leaderboardContent = document.getElementById('leaderboard-content');
    
    // Create table
    const table = document.createElement('table');
    table.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    `;
    
    // Add table header
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Rank</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Name</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Roll Number</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Department</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Score</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Time Taken</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: left; background-color: #6a5acd; color: white;">Date</th>
        </tr>
    `;
    table.appendChild(thead);
    
    // Add table body
    const tbody = document.createElement('tbody');
    
    if (studentsData.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
            <td colspan="7" style="border: 1px solid #ddd; padding: 12px; text-align: center;">No data available</td>
        `;
        tbody.appendChild(emptyRow);
    } else {
        // Add rows with student data
        studentsData.forEach((student, index) => {
            const row = document.createElement('tr');
            row.style.backgroundColor = index % 2 === 0 ? '#f9f9f9' : '#ffffff';
            
            // Format time
            const minutes = Math.floor(student.timeTaken / 60);
            const seconds = student.timeTaken % 60;
            const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Format date
            let formattedDate;
            try {
                formattedDate = new Date(student.completedAt).toLocaleDateString() + ' ' + 
                                new Date(student.completedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                formattedDate = 'N/A';
            }
            
            row.innerHTML = `
                <td style="border: 1px solid #ddd; padding: 12px;">${index + 1}</td>
                <td style="border: 1px solid #ddd; padding: 12px;">${student.name || 'N/A'}</td>
                <td style="border: 1px solid #ddd; padding: 12px;">${student.roll || 'N/A'}</td>
                <td style="border: 1px solid #ddd; padding: 12px;">${student.department || 'N/A'}</td>
                <td style="border: 1px solid #ddd; padding: 12px;">${student.score || 0}%</td>
                <td style="border: 1px solid #ddd; padding: 12px;">${formattedTime}</td>
                <td style="border: 1px solid #ddd; padding: 12px;">${formattedDate}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    table.appendChild(tbody);
    leaderboardContent.innerHTML = '';
    leaderboardContent.appendChild(table);
}

// Load leaderboard data
async function loadLeaderboard() {
    try {
        // Show leaderboard with loading message
        document.getElementById('leaderboard-overlay').style.display = 'block';
        document.getElementById('leaderboard-container').classList.remove('hidden');
        
        const leaderboardContent = document.getElementById('leaderboard-content');
        leaderboardContent.innerHTML = '<p style="text-align: center; margin: 20px 0;">Loading leaderboard data...</p>';
        
        // Fetch data from Firebase
        const studentsSnapshot = await db.collection("students").get();
        const studentsData = [];
        
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            studentsData.push({
                name: data.name,
                roll: data.roll,
                department: data.department,
                score: data.overallScore,
                timeTaken: data.totalTimeTaken,
                completedAt: data.completedAt ? data.completedAt : 
                            (data.completionTime ? data.completionTime.toDate().toISOString() : new Date().toISOString())
            });
        });
        
        // Sort by score (higher is better) and then by time (lower is better)
        studentsData.sort((a, b) => {
            if (b.score !== a.score) {
                return b.score - a.score; // Higher score first
            }
            return a.timeTaken - b.timeTaken; // Lower time first
        });
        
        // Create and populate table
        createLeaderboardTable(studentsData);
        
    } catch (error) {
        console.error("Error loading leaderboard:", error);
        const leaderboardContent = document.getElementById('leaderboard-content');
        leaderboardContent.innerHTML = `
            <p style="text-align: center; color: red; margin: 20px 0;">
                Error loading leaderboard data. Please try again.<br>
                Error details: ${error.message}
            </p>
        `;
    }
}

// Hide leaderboard
function hideLeaderboard() {
    document.getElementById('leaderboard-container').classList.add('hidden');
    document.getElementById('leaderboard-overlay').style.display = 'none';
}

// Initialize leaderboard components
function initLeaderboard() {
    // Create leaderboard elements
    createLeaderboard();
    
    // Check if we're on the results page and add button
    const resultsSection = document.getElementById('results-section');
    if (resultsSection && !resultsSection.classList.contains('hidden')) {
        addLeaderboardButton();
    } else {
        // Add event listener to check when results are shown
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'results-section' && 
                    !mutation.target.classList.contains('hidden')) {
                    addLeaderboardButton();
                }
            });
        });
        
        // Start observing
        if (resultsSection) {
            observer.observe(resultsSection, { attributes: true });
        }
        
        // Add button anyway as fallback
        setTimeout(addLeaderboardButton, 2000);
    }
}

const styleElement = document.createElement('style');
styleElement.textContent = `
    .salutation-container {
        margin-bottom: 15px;
    }
    
    .salutation-feedback {
        margin-top: 5px;
        font-size: 0.9rem;
    }
    
    .salutation-correct {
        color: var(--success-color);
    }
    
    .salutation-incorrect {
        color: var(--error-color);
    }
`;
document.head.appendChild(styleElement);

// Initialize when page is fully loaded
document.addEventListener('DOMContentLoaded', initLeaderboard);

// Also add a direct button (in case the initialization timing is off)
window.addEventListener('load', () => {
    // If button doesn't exist after 3 seconds, add it
    setTimeout(() => {
        if (!document.getElementById('view-leaderboard-btn')) {
            addLeaderboardButton();
        }
    }, 3000);
});
    </script>
</body>
</html>